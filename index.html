<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Open Catalyst Project</title>

	<link rel="stylesheet" href="dist/reset.css">
	<link rel="stylesheet" href="dist/reveal.css">
	<link rel="stylesheet" href="dist/theme/mint.css">
	<link rel="stylesheet" href="dist/theme/skelet.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
	<!-- Theme used for syntax highlighted code -->
	<link rel="stylesheet" href="plugin/highlight/monokai.css">
</head>

<body>
	<div class="reveal">
		<div class="slides">
			<section>
				<article>
					<x-grid columns=4 ai="end">
						<x-col>
							<h2 class="r-fit-text">Open Catalyst Project</h2>
							<h2 class="r-fit-text">Project Sync</h2>
						</x-col>
						<x-col span="2+3">
							<figure><img src="assets/intel-logo.svg" alt=""></figure>
						</x-col>
					</x-grid>
					<footer style="padding-top: 2vw;">
						<x-grid columns=3 ai="center">
							<x-col>
								<p>Kelvin Lee</p>
								<em>HPC AI for Science Working Group</em>
							</x-col>
						</x-grid>
					</footer>
				</article>
			</section>
			<section>
				<x-grid columns="3" ai="center">
					<x-col>
						<h1>TOC</h1>
					</x-col>
					<x-col span="2+2">
						<ol>
							<li>Profiling OCP workflow</li>
							<li>Single process profiling</li>
							<li>Multi process profiling</li>
						</ol>
					</x-col>
				</x-grid>
			</section>
			<section>
				<section>
					<x-grid columns="4" ai="center">
						<x-col>
							<h2>The
								BAPP package
							</h2>
							<em>
								Bookkeeping AI Profiling with Python
							</em>
						</x-col>
						<x-col span="2+3">
							<p>Simple CLI for reproducible profiling and data collection</p>
							<ul>
								<li>Aggregates and reports multiple data sources into JSON format</li>
								<ul>
									<li>Environment variables/SLURM configuration</li>
									<li>Software configuration</li>
									<li>Hardware configuration</li>
								</ul>
								<li>Extensive hash tracking for data control</li>
								<li>Supports framework profiling and VTune</li>
							</ul>
						</x-col>
					</x-grid>
				</section>
				<section>
					<h2>PyTorch profiler</h2>
					<hr>
					<x-grid columns="3" ai="top">
						<x-col>
							<h3>Step 1</h3>
							<p><small>Write minimal profiling script</small></p>
							<pre><code># use default settings for DimeNet++
dpp = DimeNetPP(**model_config)
# wrap in PyTorch Lightning module; disable force computation until
# we can address the double backprop
model = S2EFLitModule(dpp, regress_forces=False)

# initialize PyTorch profiler through the PyTorch lightning interface
profiler = PyTorchProfiler(
	dirpath=pp,
	group_by_input_shapes=True,
	wait=0,
	warmup=0,
	active=10,
	repeat=3,
	profile_memory=True,
	with_stack=True,
	with_flops=True,
)

data_module = DGLDataModule(
	"../data/s2ef/200k/train",
	batch_size=config.get("batch_size"),
	num_workers=config.get("num_workers"),
)
trainer = Trainer(
    accelerator="cpu",
    strategy="ddp" if num_procs > 1 else None,
    num_processes=num_procs,
    num_nodes=1,
    max_steps=20,
    logger=False,
    log_every_n_steps=100,
    enable_progress_bar=False,
    enable_checkpointing=False,
    profiler=profiler,
    num_sanity_val_steps=0,
    enable_model_summary=True,
)

trainer.fit(model, datamodule=data_module)</code></pre>
						</x-col>
						<x-col span="2+2">
							<h3>Step 2</h3>
							<p><small>Configure profiling and data collection</small></p>
							<pre><code>task: frameworkprofiling
binary: numactl -C 0-35 -m 0 python lit_dimenetpp.py
profile_dir: pt-profile
requested_specs:
	- lscpu
	- conda
	- environment
	- pytorch
aux_files:
	config: bapp_pt_profile.yml
	script: lit_dimenetpp.py
env_vars:
	OMP_NUM_THREADS: 36
	BATCHSIZE: 16
	NUM_PROCS: 1
	NUM_WORKERS: 0
	SEED: 1205</code></pre>
							<h3>Step 3</h3>
							<p><small><code>python -m bapp.cli bapp_pt_profile.yml</code></small></p>
						</x-col>
					</x-grid>
				</section>
				<section>
					<h2>BAPP organization</h2>
					<p>Data collection organized in hierarchical manner:</p>
					<ol>
						<li>Task (i.e. <code>FrameworkProfiling</code>/<code>vtune</code> </li>
						<li>Git commit hash</li>
						<li>Configuration hash</li>
						<li>Collection (in the case of VTune)</li>
					</ol>
					<p>Prevents redundant code/configuration runs, traceable configurations</p>
				</section>
				<section>
					<x-grid columns="2" ai="top">
						<x-col>
							<pre><code>b8a4674/
└── 4619fab/
	├── bapp.log
	├── bapp_pt_profile.yml
	├── lit_dimenetpp.py
	├── profile
	│   └── fit-training_step.1651520873629.pt.trace.json
	└── specifications
		├── Conda.json
		├── Environment.json
		├── LSCPU.json
		└── PyTorch.json

3 directories, 8 files
</code></pre>
						</x-col>
						<x-col>
							<p>Capture and store specifciations</p>
							<ul>
								<li>Conda environment and packages</li>
								<li>Environment variables set (includes SLURM)</li>
								<li>CPU specifications</li>
								<li>Framework build arguments</li>
							</ul>
						</x-col>
					</x-grid>
				</section>
			</section>
			<section>
				<section>
					<h2>Single process performance</h2>
				</section>
				<section>
					<h2>Characterizing single process performance</h2>
					<x-grid columns="4" ai="center">
						<x-col>
							<ul>
								<li>Batch size of 16 on ICX (36 cores, 2 sockets)</li>
								<li>Training step corresponds to ~120 SP GFLOPS</li>
								<li>Memory peak for graph index operations is ~234 GB/s (150 read, 85 write)</li>
								<li>~20% of clockticks are cache-bound</li>
							</ul>
						</x-col>
						<x-col span="2+3">
							<figure><img src="assets/vtune-physical.png" alt=""></figure>
						</x-col>
					</x-grid>
				</section>
				<section>
					<h2>DimeNet++ trace</h2>
					<x-grid columns="3" ai="center">
						<x-col span="row">
							<figure><img src="assets/dimenet-trace.png" alt=""></figure>
						</x-col>
						<x-col>
							<p>Sequential RBF/SBF computation</p>
						</x-col>
						<x-col>
							<p>Tensor creation penalty</p>
						</x-col>
						<x-col>
							Recursive node message passing
						</x-col>
					</x-grid>
				</section>
				<section>
					<h2>Need middle-level information?</h2>
					<p>Reconcile high level PyTorch profile with low level VTune</p>
				</section>
				<section>
					<figure><img src="assets/dimenet-forward-backward.png" alt=""></figure>
					<p>High memory usage for node message passing forward/backward pass</p>
				</section>
				<section>
					<figure><img src="assets/vtune-physical.png" alt="">
						<caption>numactl -C 0-35 -m 0</caption>
					</figure>
					<figure><img src="assets/dimenet-hyperthreading.png" alt="">
						<caption>numactl -C 0-35,72-105 -m 0</caption>
					</figure>
				</section>
			</section>
		</div>
	</div>
	<div id="slide-footer" class="footer">
		<x-grid columns="3" ai="center">
			<x-col>
				<small>Intel Confidential</small>
			</x-col>
			<x-col>
				<small>Intel AXG&middot;HPC EUE</small>
			</x-col>
			<x-col>
				<small>Kelvin Lee</small>
			</x-col>
		</x-grid>
	</div>

	<script src="plugin/skelet/app.js"></script>
	<script src="plugin/skelet/modules.js"></script>
	<script src="dist/reveal.js"></script>
	<script src="plugin/notes/notes.js"></script>
	<script src="plugin/markdown/markdown.js"></script>
	<script src="plugin/highlight/highlight.js"></script>
	<script src="plugin/math/math.js"></script>
	<script src="plugin/zoom/zoom.js"></script>
	<script type="text/javascript">
		window.addEventListener("load", function () {

			revealDiv = document.querySelector("body div.reveal")
			footer = document.getElementById("slide-footer");
			revealDiv.appendChild(footer);

		});
	</script>
	<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
	<script>
		mermaid.initialize({
			startOnLoad: true,
		});
	</script>
	<script>
		// More info about initialization & config:
		// - https://revealjs.com/initialization/
		// - https://revealjs.com/config/
		Reveal.initialize({
			hash: true,
			slideNumber: true,
			transition: 'fade',
			transitionSpeed: 'slow',
			controlsLayout: 'edges',
			viewDistance: 50,
			preloadIframes: true,
			// Learn about plugins: https://revealjs.com/plugins/
			plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealMath, RevealZoom],
			dependencies: [{ src: 'plugin/mermaid/mermaid.js' }]
		});
	</script>
</body>

</html>